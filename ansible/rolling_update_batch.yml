# STEP 1: Ensure no container is using this port
- name: "Force stop and remove any container using port {{ instance.port }}"
  shell: |
    docker ps -q --filter "publish={{ instance.port }}" | xargs --no-run-if-empty docker rm -f
  ignore_errors: yes

# STEP 2: Deploy new container to the specified port
- name: "Deploy new container to {{ instance.name }} on port {{ instance.port }}"
  community.docker.docker_container:
    name: "{{ instance.name }}"
    image: "{{ full_image_name }}"
    state: started
    pull: yes
    restart_policy: always
    cleanup: yes
    ports:
      - "{{ instance.port }}:8000"

# STEP 3: Wait for the new container to be healthy
- name: "Wait for new container {{ instance.name }} to be healthy"
  uri:
    url: "http://localhost:{{ instance.port }}/"
    status_code: 200
  retries: 5
  delay: 10
